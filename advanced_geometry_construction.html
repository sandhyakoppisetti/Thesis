<!DOCTYPE html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
  <meta charset="UTF-8">
  
  <title>Boundless : Introduction to PostGIS : Section 28: Advanced Geometry Constructions</title>

  <link rel="profile" href="http://gmpg.org/xfn/11">
  <link rel="stylesheet" href="http://boundlessgeo.com/wp-content/themes/open-geo/style.css" type="text/css"/>

<link rel="stylesheet" id="style-css" href="http://boundlessgeo.com/wp-content/themes/open-geo/style.css?ver=3.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="_static/extra.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <!-- <link rel="stylesheet" type="text/css" href="http://opengeo.org/include/superfish/css/superfish.css" media="screen" /> -->

  <script type="text/javascript" src="http://boundlessgeo.com/wordpress/wp-includes/js/jquery/jquery.js?ver=1.10.2"></script>
  <script type="text/javascript" src="http://boundlessgeo.com/wordpress/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1"></script>

  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html'
    };
  </script>
  <script type="text/javascript" src="_static/jquery.js"></script>
  <script type="text/javascript" src="_static/underscore.js"></script>
  <script type="text/javascript" src="_static/doctools.js"></script>
  <script type="text/javascript" src="_static/searchtools.js"></script>
  <script type="text/javascript" src="searchindex.js"></script>
  <!-- 
  <script type="text/javascript" src="http://opengeo.org/include/superfish/js/jquery-1.2.6.min.js"></script> 
  <script type="text/javascript" src="http://opengeo.org/include/superfish/js/hoverIntent.js"></script>
  <script type="text/javascript" src="http://opengeo.org/include/superfish/js/superfish.js"></script>
  <script type="text/javascript" src="http://opengeo.org/include/superfish/js/supersubs.js"></script>
  <script>
	$(document).ready(function(){
		$("ul.sf-menu").supersubs({
		}).superfish();  // call supersubs first, then superfish, so that subs are
						 // not display:none when measuring. Call before initialising
						 // containing tabs for same reason.
	});
	</script>
  -->
  <link rel="shortcut icon" href="_static/favicon.ico"/>
      <link rel="top" title="Introduction to PostGIS" href="index.html" />
      <link rel="next" title="Section 29: Tuning PostgreSQL for Spatial" href="tuning.html" />
      <link rel="prev" title="Section 27: Tracking Edit History using Triggers" href="history_tracking.html" />

<script type="text/javascript" src="//use.typekit.net/ijz1lwt.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>

<!--[if lt IE 9]>
<script src="http://boundlessgeo.com/wp-content/themes/open-geo/js/html5.js" type="text/javascript"></script>
<![endif]-->


</head>
<body class="page">

	<div id="wrapper">
		<header id="masthead" class="site-header" role="banner">
			<div class="container">
				<a href="http://boundlessgeo.com/" rel="home" id="logo"><img src="http://boundlessgeo.com/wp-content/themes/open-geo/images/logo.png"></a>

				<div class="pull-right">
					<div class="pull-left">
						<div class="menu-main-container">
							<ul id="menu-main" class="menu">
                <li class="solutions-primary menu-item menu-item-type-post_type menu-item-object-page menu-item-22"><a href="http://boundlessgeo.com/solutions/">Solutions</a></li>
                <li class="resources-primary menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-16 current_page_item menu-item-23"><a href="http://boundlessgeo.com/resources/">Resources</a></li>
                <li class="about-primary menu-item menu-item-type-post_type menu-item-object-page menu-item-24"><a href="http://boundlessgeo.com/about/">About</a></li>
                <li class="support-primary menu-item menu-item-type-post_type menu-item-object-page menu-item-25"><a href="http://boundlessgeo.com/support/">Support</a></li>
							</ul>
						</div>
					</div>
					<div class="search dropdown">
					  <a class="dropdown-toggle" data-toggle="dropdown" href="#"><i class="search-icon"></i></a>
						  <div class="dropdown-menu" role="menu" aria-labelledby="dLabel">
							  <form method="get" id="searchform" class="searchform" action="http://boundlessgeo.com/" role="search">
								  <label for="s" class="screen-reader-text">Search</label>
							  <input type="search" class="field" name="s" value="" id="s" placeholder="Search …">
							  <input type="submit" class="submit" id="searchsubmit" value="Search">
							  </form>
						  </div>
					</div>
					<div class="download-link">
						<ul id="menu-download-link" class="menu">
							<li id="menu-item-5817" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5817">
								<a href="http://boundlessgeo.com/download/">Download</a>
							</li>
						</ul>
					</div>
				</div>

			</div><!--closes container-->

		</header>
<section class="resources page-resources">
  <div class="secondarynav">
     <div class="container">
       	<div class="menu-resources-container">
	   <ul id="menu-resources" class="menu">
              <li id="menu-item-5892" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-16 current_page_item menu-item-5892"><a href="http://boundlessgeo.com/resources/" >Overview</a></li>
              <li id="menu-item-7099" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7099"><a href="http://boundlessgeo.com/resources/documentation/" >Documentation</a></li>
              <li id="menu-item-5885" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5885"><a href="http://boundlessgeo.com/resources/trainings/" >Trainings</a></li>
              <li id="menu-item-6432" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-6432"><a href="http://workshops.boundlessgeo.com/" >Workshops</a></li>
              <li id="menu-item-5318" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5318"><a href="http://boundlessgeo.com/resources/case-studies/" >Case Studies</a></li>
              <li id="menu-item-5891" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5891"><a href="http://boundlessgeo.com/resources/white-papers/" >White Papers</a></li>
           </ul>
         </div>		
      </div>
    </div>
</section>
<header class="page-header">
	<div class="container">
		<h1 class="page-title"><a href="index.html">Introduction to PostGIS</a></h1>
		<p>PostGIS extends PostgreSQL with robust spatial database management capabilities. <a href="http://boundlessgeo.com/solutions/solutions-software/postgis/">More info</a></p>
	</div>
</header><div id="pageheading"><div class="contents"><h1>Introduction to PostGIS</h1></div></div>

  <div id="content" class="contents">
  <!--
<div id="breadcrumbs">
  <a href="http://boundlessgeo.com/">Home</a> &raquo;
  <a href="http://boundlessgeo.com/resources/">Resources</a> &raquo;
  <a href="http://workshops.boundlessgeo.com/">Workshops</a> &raquo;
  <a href="index.html">Introduction to PostGIS</a>
  
     &raquo; <a href="">Section 28: Advanced Geometry Constructions</a>
</div> -->

  <div id="rightbar_main">
      
  <div class="section" id="section-28-advanced-geometry-constructions">
<span id="advanced-geometry-construction"></span><h1>Section 28: Advanced Geometry Constructions<a class="headerlink" href="#section-28-advanced-geometry-constructions" title="Permalink to this headline">¶</a></h1>
<p>The <tt class="docutils literal"><span class="pre">nyc_subway_stations</span></tt> layer has provided us with lots of interesting examples so far, but there is something striking about it:</p>
<img alt="_images/adv_geom0.jpg" src="_images/adv_geom0.jpg" />
<p>Although it is a database of all the stations, it doesn&#8217;t allow easy visualization of routes! In this chapter we will use advanced features of PostgreSQL and PostGIS to build up a new linear routes layer from the point layer of subway stations.</p>
<p>Our task is made especially difficult by two issues:</p>
<ul class="simple">
<li>The <tt class="docutils literal"><span class="pre">routes</span></tt> column of <tt class="docutils literal"><span class="pre">nyc_subway_stations</span></tt> has multiple route identifiers in each row, so a station that might appear in multiple routes appears only once in the table.</li>
<li>Related to the previous issue, there is no route ordering information in the stations table, so while it is possible to find all the stations in a particular route, it&#8217;s not possible using the attributes to determine what the order in which trains travel through the stations.</li>
</ul>
<p>The second problem is the harder one: given an unordered set of points in a route, how do we order them to match the actual route.</p>
<p>Here are the stops for the &#8216;Q&#8217; train:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span>
<span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>In this picture, the stops are labelled with their unique <tt class="docutils literal"><span class="pre">gid</span></tt> primary key.</p>
<img alt="_images/adv_geom1.jpg" src="_images/adv_geom1.jpg" />
<p>If we start at one of the end stations, the next station on the line seems to always be the closest. We can repeat the process each time as long as we exclude all the previously found stations from our search.</p>
<p>There are two ways to run such an iterative routine in a database:</p>
<ul class="simple">
<li>Using a procedural language, like <a class="reference external" href="http://www.postgresql.org/docs/current/static/plpgsql.html">PL/PgSQL</a>.</li>
<li>Using recursive <a class="reference external" href="http://www.postgresql.org/docs/current/static/queries-with.html">common table expressions</a>.</li>
</ul>
<p>Common table expressions (CTE) have the virtue of not requiring a function definition to run. Here&#8217;s the CTE to calculate the route line of the &#8216;Q&#8217; train, starting from the northernmost stop (where <tt class="docutils literal"><span class="pre">gid</span></tt> is 304).</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">next_stop</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">idlist</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="p">(</span><span class="k">SELECT</span>
      <span class="n">geom</span><span class="p">,</span>
      <span class="nb">ARRAY</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span> <span class="k">AS</span> <span class="n">idlist</span>
    <span class="k">FROM</span> <span class="n">nyc_subway_stations</span>
    <span class="k">WHERE</span> <span class="n">gid</span> <span class="o">=</span> <span class="mi">304</span><span class="p">)</span>
    <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="p">(</span><span class="k">SELECT</span>
      <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span>
      <span class="n">array_append</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">idlist</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">gid</span><span class="p">)</span> <span class="k">AS</span> <span class="n">idlist</span>
    <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span><span class="p">,</span> <span class="n">next_stop</span> <span class="n">n</span>
    <span class="k">WHERE</span> <span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="k">AND</span> <span class="k">NOT</span> <span class="n">n</span><span class="p">.</span><span class="n">idlist</span> <span class="o">@&gt;</span> <span class="nb">ARRAY</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">gid</span><span class="p">]</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">ST_Distance</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">ASC</span>
    <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">geom</span><span class="p">,</span> <span class="n">idlist</span> <span class="k">FROM</span> <span class="n">next_stop</span><span class="p">;</span>
</pre></div>
</div>
<p>The CTE consists of two halves, unioned together:</p>
<ul class="simple">
<li>The first half establishes a start point for the expression. We get the initial geometry and initialize the array of visited identifiers, using the record of &#8220;gid&#8221; 304 (the end of the line).</li>
<li>The second half iterates until it finds no further records. At each iteration it takes in the value at the previous iteration via the self-reference to &#8220;next_stop&#8221;. We search every stop on the Q line (<strong>strpos(s.routes,&#8217;Q&#8217;)</strong>) that we have not already added to our visited list (<strong>NOT n.idlist &#64;&gt; ARRAY[s.gid]</strong>) and order them by their distance from the previous point, taking just the first one (the nearest).</li>
</ul>
<p>Beyond the recursive CTE itself, there are a number of advanced PostgreSQL array features being used here:</p>
<ul class="simple">
<li>We are using ARRAY! PostgreSQL supports arrays of any type. In this case we have an array of integers, but we could also build an array of geometries, or any other PostgreSQL type.</li>
<li>We are using <strong>array_append</strong> to build up our array of visited identifiers.</li>
<li>We are using the <strong>&#64;&gt;</strong> array operator (&#8220;array contains&#8221;) to find which of the Q train stations we have already visited. The <strong>&#64;&gt;</strong> operators requires ARRAY values on both sides, so we have to turn the individual &#8220;gid&#8221; numbers into single-entry arrays using the ARRAY[] syntax.</li>
</ul>
<p>When you run the query, you get each geometry in the order it is found (which is the route order), as well as the list of identifiers already visited. Wrapping the geometries into the PostGIS <a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_MakeLine.html">ST_MakeLine</a> aggregate function turns the set of geometries into a single linear output, constructed in the provided order.</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">next_stop</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">idlist</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="p">(</span><span class="k">SELECT</span>
      <span class="n">geom</span><span class="p">,</span>
      <span class="nb">ARRAY</span><span class="p">[</span><span class="n">gid</span><span class="p">]</span> <span class="k">AS</span> <span class="n">idlist</span>
    <span class="k">FROM</span> <span class="n">nyc_subway_stations</span>
    <span class="k">WHERE</span> <span class="n">gid</span> <span class="o">=</span> <span class="mi">304</span><span class="p">)</span>
    <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="p">(</span><span class="k">SELECT</span>
      <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span>
      <span class="n">array_append</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">idlist</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">gid</span><span class="p">)</span> <span class="k">AS</span> <span class="n">idlist</span>
    <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span><span class="p">,</span> <span class="n">next_stop</span> <span class="n">n</span>
    <span class="k">WHERE</span> <span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="k">AND</span> <span class="k">NOT</span> <span class="n">n</span><span class="p">.</span><span class="n">idlist</span> <span class="o">@&gt;</span> <span class="nb">ARRAY</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">gid</span><span class="p">]</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">ST_Distance</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">ASC</span>
    <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">ST_MakeLine</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span> <span class="k">FROM</span> <span class="n">next_stop</span><span class="p">;</span>
</pre></div>
</div>
<p>Which looks like this:</p>
<img alt="_images/adv_geom3.jpg" src="_images/adv_geom3.jpg" />
<p><em>Success!</em></p>
<p>Except, two problems:</p>
<ul class="simple">
<li>We are only calculating one subway route here, we want to calculate all the routes.</li>
<li>Our query includes a piece of <em>a priori</em> knowledge, the initial station identifier that serves as the seed for the search algorithm that builds the route.</li>
</ul>
<p>Let&#8217;s tackle the hard problem first, figuring out the first station on a route without manually eyeballing the set of stations that make up the route.</p>
<p>Our &#8216;Q&#8217; train stops can serve as a starting point. What characterizes the end stations of the route?</p>
<img alt="_images/adv_geom2.jpg" src="_images/adv_geom2.jpg" />
<p>One answer is &#8220;they are the most northerly and southerly stations&#8221;. However, imagine if the &#8216;Q&#8217; train ran from east to west. Would the condition still hold?</p>
<p>A less directional characterization of the end stations is &#8220;they are the furthest stations from the middle of the route&#8221;. With this characterization it doesn&#8217;t matter if the route runs north/south or east/west, just that it run in more-or-less one direction, particularly at the ends.</p>
<p>Since there is no 100% heuristic to figure out the end points, let&#8217;s try this second rule out.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">An obvious failure mode of the &#8220;furthest from middle&#8221; rule is a circular line, like the Circle Line in London, UK. Fortunately, New York doesn&#8217;t have any such lines!</p>
</div>
<p>To work out the end stations of every route, we first have to work out what routes there are! We find the distinct routes.</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">WITH</span> <span class="n">routes</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">AS</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">routes</span><span class="p">;</span>
</pre></div>
</div>
<p>Note the use of two advanced PostgreSQL ARRAY functions:</p>
<ul class="simple">
<li><strong>string_to_array</strong> takes in a string and splits it into an array using a separator character. <a class="reference external" href="http://www.postgresql.org/docs/current/static/arrays.html">PostgreSQL supports arrays</a> of any type, so it&#8217;s possible to build arrays of strings, as in this case, but also of geometries and geographies as we&#8217;ll see later in this example.</li>
<li><strong>unnest</strong> takes in an array and builds a new row for each entry in the array. The effect is to take a &#8220;horizontal&#8221; array embedded in a single row and turn it into a &#8220;vertical&#8221; array with a row for each value.</li>
</ul>
<p>The result is a list of all the unique subway route identifiers.</p>
<div class="highlight-python"><pre> route
-------
 1
 2
 3
 4
 5
 6
 7
 A
 B
 C
 D
 E
 F
 G
 J
 L
 M
 N
 Q
 R
 S
 V
 W
 Z
(24 rows)</pre>
</div>
<p>We can build on this result by joining it back to the <tt class="docutils literal"><span class="pre">nyc_subway_stations</span></tt> table to create a new table that has, for each route, a row for every station on that route.</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">WITH</span> <span class="n">routes</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">AS</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">),</span>
<span class="n">stops</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span>
  <span class="k">FROM</span> <span class="n">routes</span> <span class="n">r</span>
  <span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span>
  <span class="k">ON</span> <span class="p">(</span><span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">stops</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-python"><pre> gid |                      geom                      | route
-----+----------------------------------------------------+-------
   2 | 010100002026690000CBE327F938CD21415EDBE1572D315141 | 1
   3 | 010100002026690000C676635D10CD2141A0ECDB6975305141 | 1
  20 | 010100002026690000AE59A3F82C132241D835BA14D1435141 | 1
  22 | 0101000020266900003495A303D615224116DA56527D445141 | 1
                            ...etc...</pre>
</div>
<p>Now we can find the center point by collecting all the stations for each route into a single multi-point, and calculating the centroid of that multi-point.</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">WITH</span> <span class="n">routes</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">AS</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">),</span>
<span class="n">stops</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span>
  <span class="k">FROM</span> <span class="n">routes</span> <span class="n">r</span>
  <span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span>
  <span class="k">ON</span> <span class="p">(</span><span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">),</span>
<span class="n">centers</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">ST_Centroid</span><span class="p">(</span><span class="n">ST_Collect</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">,</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">stops</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">centers</span><span class="p">;</span>
</pre></div>
</div>
<p>The center point of the collection of &#8216;Q&#8217; train stops looks like this:</p>
<img alt="_images/adv_geom4.jpg" src="_images/adv_geom4.jpg" />
<p>So the northern most stop, the end point, appears to also be the stop furthest from the center. Let&#8217;s calculate the furthest point for every route.</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">WITH</span> <span class="n">routes</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">AS</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">),</span>
<span class="n">stops</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span>
  <span class="k">FROM</span> <span class="n">routes</span> <span class="n">r</span>
  <span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span>
  <span class="k">ON</span> <span class="p">(</span><span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">),</span>
<span class="n">centers</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">ST_Centroid</span><span class="p">(</span><span class="n">ST_Collect</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">,</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">stops</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">),</span>
<span class="n">stops_distance</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">ST_Distance</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">distance</span>
  <span class="k">FROM</span> <span class="n">stops</span> <span class="n">s</span> <span class="k">JOIN</span> <span class="n">centers</span> <span class="k">c</span>
  <span class="k">ON</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">route</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">route</span><span class="p">)</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">route</span><span class="p">,</span> <span class="n">distance</span> <span class="k">DESC</span>
<span class="p">),</span>
<span class="n">first_stops</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="n">route</span><span class="p">)</span> <span class="n">stops_distance</span><span class="p">.</span><span class="o">*</span>
  <span class="k">FROM</span> <span class="n">stops_distance</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">first_stops</span><span class="p">;</span>
</pre></div>
</div>
<p>We&#8217;ve added two sub-queries this time:</p>
<ul class="simple">
<li><strong>stops_distance</strong> joins the centers points back to the stations table and calculates the distance between the stations and center for each route. The result is ordered such that the records come out in batches for each route, with the furthest station as the first record of the batch.</li>
<li><strong>first_stops</strong> filters the <strong>stops_distance</strong> output by only taking the first record for each distinct group. Because of the way we ordered <strong>stops_distance</strong> the first record is the furthest record, which means it&#8217;s the station we want to use as our starting seed to build each subway route.</li>
</ul>
<p>Now we know every route, and we know (approximately) what station each route starts from: we&#8217;re ready to generate the route lines!</p>
<p>But first, we need to turn our recursive CTE expression into a function we can call with parameters.</p>
<div class="highlight-sql"><pre>CREATE OR REPLACE function walk_subway(integer, text) returns geometry AS
$$
WITH RECURSIVE next_stop(geom, idlist) AS (
    (SELECT
      geom AS geom,
      ARRAY[gid] AS idlist
    FROM nyc_subway_stations
    WHERE gid = $1)
    UNION ALL
    (SELECT
      s.geom AS geom,
      array_append(n.idlist, s.gid) AS idlist
    FROM nyc_subway_stations s, next_stop n
    WHERE strpos(s.routes, $2) != 0
    AND NOT n.idlist @&gt; ARRAY[s.gid]
    ORDER BY ST_Distance(n.geom, s.geom) ASC
    LIMIT 1)
)
SELECT ST_MakeLine(geom) AS geom
FROM next_stop;
$$
language 'sql';</pre>
</div>
<p>And now we are ready to go!</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">nyc_subway_lines</span> <span class="k">AS</span>
<span class="c1">-- Distinct route identifiers!</span>
<span class="k">WITH</span> <span class="n">routes</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">unnest</span><span class="p">(</span><span class="n">string_to_array</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">AS</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">nyc_subway_stations</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">),</span>
<span class="c1">-- Joined back to stops! Every route has all its stops!</span>
<span class="n">stops</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span>
  <span class="k">FROM</span> <span class="n">routes</span> <span class="n">r</span>
  <span class="k">JOIN</span> <span class="n">nyc_subway_stations</span> <span class="n">s</span>
  <span class="k">ON</span> <span class="p">(</span><span class="n">strpos</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">routes</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">route</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">),</span>
<span class="c1">-- Collects stops by routes and calculate centroid!</span>
<span class="n">centers</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">ST_Centroid</span><span class="p">(</span><span class="n">ST_Collect</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">,</span> <span class="n">route</span>
  <span class="k">FROM</span> <span class="n">stops</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">route</span>
<span class="p">),</span>
<span class="c1">-- Calculate stop/center distance for each stop in each route.</span>
<span class="n">stops_distance</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">ST_Distance</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">geom</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span> <span class="n">distance</span>
  <span class="k">FROM</span> <span class="n">stops</span> <span class="n">s</span> <span class="k">JOIN</span> <span class="n">centers</span> <span class="k">c</span>
  <span class="k">ON</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">route</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">route</span><span class="p">)</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">route</span><span class="p">,</span> <span class="n">distance</span> <span class="k">DESC</span>
<span class="p">),</span>
<span class="c1">-- Filter out just the furthest stop/center pairs.</span>
<span class="n">first_stops</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="n">route</span><span class="p">)</span> <span class="n">stops_distance</span><span class="p">.</span><span class="o">*</span>
  <span class="k">FROM</span> <span class="n">stops_distance</span>
<span class="p">)</span>
<span class="c1">-- Pass the route/stop information into the linear route generation function!</span>
<span class="k">SELECT</span>
  <span class="n">ascii</span><span class="p">(</span><span class="n">route</span><span class="p">)</span> <span class="k">AS</span> <span class="n">gid</span><span class="p">,</span> <span class="c1">-- QGIS likes numeric primary keys</span>
  <span class="n">route</span><span class="p">,</span>
  <span class="n">walk_subway</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span>
<span class="k">FROM</span> <span class="n">first_stops</span><span class="p">;</span>

<span class="c1">-- Do some housekeeping too</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">nyc_subway_lines</span> <span class="k">ADD</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">gid</span><span class="p">);</span>
</pre></div>
</div>
<p>Here&#8217;s what our final table looks like visualized in QGIS:</p>
<img alt="_images/adv_geom5.jpg" src="_images/adv_geom5.jpg" />
<p>As usual, there are some problems with our simple understanding of the data:</p>
<ul class="simple">
<li>there are actually two &#8216;S&#8217; (short distance &#8220;shuttle&#8221;) trains, one in Manhattan and one in the Rockaways, and we join them together because they are both called &#8216;S&#8217;;</li>
<li>the &#8216;4&#8217; train (and a few others) splits at the end of one line into two terminuses, so the &#8220;follow one line&#8221; assumption breaks and the result has a funny hook on the end.</li>
</ul>
<p>Hopefully this example has provided a taste of some of the complex data manipulations that are possible combining the advanced features of PostgreSQL and PostGIS.</p>
<div class="section" id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.postgresql.org/docs/current/static/arrays.html">PostgreSQL Arrays</a></li>
<li><a class="reference external" href="http://www.postgresql.org/docs/current/static/functions-array.html">PostgreSQL Array Functions</a></li>
<li><a class="reference external" href="http://www.postgresql.org/docs/current/static/queries-with.html">PostgreSQL Recursive Common TABLE Expressions</a></li>
<li><a class="reference external" href="http://postgis.net/docs/manual-2.1/ST_MakeLine.html">PostGIS ST_MakeLine</a></li>
</ul>
</div>
</div>


      <!-- Next/Prev -->
      <div class="selfclear pagination-nav">
          <div class="left"><strong>Previous</strong>: <a href="history_tracking.html" title="previous chapter">Section 27: Tracking Edit History using Triggers</a></div>
          <div class="right"><strong>Next</strong>: <a href="tuning.html" title="next chapter">Section 29: Tuning PostgreSQL for Spatial</a></div>
      </div>

  </div> <!-- rightbar_main -->

  <div id="rightbar_bar">
    
      <div id="toc" class="section">
        <h4 class="pngfix">Page Contents</h4>
        <ul>
<li><a class="reference internal" href="#">Section 28: Advanced Geometry Constructions</a><ul>
<li><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</li>
</ul>

        <div class="section-footer"></div>
      </div>
        <div class="section">
          <h3>Continue Reading</h3>
          <p style="margin-top:1em"><b>Previous:</b> <a href="history_tracking.html" title="previous chapter">Section 27: Tracking Edit History using Triggers</a></p>
          <p><b>Next:</b> <a href="tuning.html" title="next chapter">Section 29: Tuning PostgreSQL for Spatial</a></p>
          </ul>
        </div>

   <h4>About Boundless</h4>
   <p>Boundless provides <a href="http://boundlessgeo.com/solutions/">commercial open source software</a> for internet mapping and geospatial application development. We are dedicated to the growth and support of open source software.</p>

    <h4>License</h4>
    <p>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons Non Commercial-Attribution-Share Alike 3.0 United States License</a>.  Feel free to use this material, but we ask that you please retain the Boundless branding, logos and style.</p>
<p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a></p>
<!--
<ul id="relatedlinks" class="selfclear">
  <li class="first">
    <a href="tuning.html" title="Section 29: Tuning PostgreSQL for Spatial"
       accesskey="N">next</a></li>
  <li>
    <a href="history_tracking.html" title="Section 27: Tracking Edit History using Triggers"
       accesskey="P">previous</a>|</li>
</ul> -->
  </div> <!-- rightbar_bar -->

  </div> <!-- content -->
  <div id="footer">
    <footer id="colophon" class="site-footer" role="contentinfo">
		<div class="container">
			<div class="row">
				<div class="span2">
					<h5>Solutions</h5>
					<div class="footer-solutions-menu">
						<ul id="menu-solutions" class="menu">
							<li><a href="http://boundlessgeo.com/solutions/">Overview</a></li>
							<li><a href="http://boundlessgeo.com/opengeo-suite/">OpenGeo Suite</a></li>
							<li><a href="http://boundlessgeo.com/solutions/mapmeter/">MapMeter</a></li>
							<li><a href="http://boundlessgeo.com/solutions/solutions-software/">Software</a></li>
							<li><a href="http://boundlessgeo.com/solutions/solutions-industry/">Industries</a></li>
						</ul>
					</div>
				</div>
				<div class="span2">
					<h5>Resources</h5>
					<div class="footer-resources-menu">
						<ul id="menu-resources" class="menu">
              <li><a href="http://boundlessgeo.com/resources/">Overview</a></li>
							<li><a href="http://boundlessgeo.com/documentation/">Documentation</a></li>
							<li><a href="http://boundlessgeo.com/resources/trainings/">Trainings</a></li>
							<li><a href="http://workshops.boundlessgeo.com/">Workshops</a></li>
							<li><a href="http://boundlessgeo.com/case-studies/">Case Studies</a></li>
							<li><a href="http://boundlessgeo.com/resources/white-papers/">White Papers</a></li>
						</ul>
					</div>
				</div>
				<div class="span2">
					<h5>About Us</h5>
					<div class="footer-about-menu">
						<ul id="menu-about-menu" class="menu">
              <li><a href="http://boundlessgeo.com/about/">Overview</a></li>
							<li><a href="http://boundlessgeo.com/why-boundless/">Why Boundless</a></li>
							<li><a href="http://boundlessgeo.com/about/team/">Team</a></li>
							<li><a href="http://boundlessgeo.com/resources/careers/">Careers</a></li>
							<li><a href="http://boundlessgeo.com/resources/partners/">Partners</a></li>
							<li><a href="http://boundlessgeo.com/blog/">Blog</a></li>
							<li><a href="http://boundlessgeo.com/resources/news/">News &amp; Media</a></li>
              <li><a href="http://boundlessgeo.com/general-information/">Contact</a></li>
            </ul></div>
  				</div>

				<div class="span6 site-info">

					<div class="row-fluid">
						<div class="span6">
							<h5>Contact</h5>
							<p class="address">
								<span>155 Water Street, Suite 4-10</span>
								<span>Brooklyn, NY 11201</span>
								<span>1-877-673-6436</span>
								<span>contact@boundlessgeo.com</span>
							</p>
						</div>
						<div class="span6">
							<span class="social"><i class="twitter"></i><a href="https://twitter.com/boundlessgeo" target="_blank">Follow us on Twitter</a></span>
							<span class="social"><i class="linkedIn"></i><a href="http://www.linkedin.com/company/boundlessgeo" target="_blank">Follow us on Linkedin</a></span>
						</div>
					</div>

				</div>
			</div>
			<div class="row">
				<div class="span12 footer-sub-menu">
					<div class="menu-footer-menu-container">
						<ul id="menu-footer-menu" class="menu">
							<li><a href="http://boundlessgeo.com/terms-service/">Terms of Service</a></li>
							<li><a href="http://boundlessgeo.com/privacy-policy/">Privacy Policy</a></li>
							<li><a href="http://boundlessgeo.com/site-map/">Site Map</a></li>
							<li><a href="http://boundlessgeo.com/">© Boundless</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<a class="question btn btn-primary" href="http://boundlessgeo.com/general-information/?contact-variable=ask_a_question"><i class="bubble"></i>Ask A Question</a>
	</footer>
  </div><!-- footer -->

</div><!-- container -->

<script type="text/javascript" src="http://boundlessgeo.com/wp-content/themes/open-geo/js/dropdown.js"></script>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-3879903-6");
pageTracker._trackPageview();
} catch(err) {}
</script>

  </body>
</html>